<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Australia</title>
	<link rel="stylesheet" href="/css/bootstrap.css">

	<style>
		/*body {
			background-image: url('/img/LO5A2837.JPG');
			background-size: cover;
		}*/
		[v-cloak] {
			display: none;
		}
		.messaging {
			margin: auto;
			width: 300px;
		}
		.close {
			color: #e04545;
		}
	</style>
</head>
<body>
	
	<div class="container">
		<div class="messaging">
			<div class="list-group" v-cloak>
				<div v-for="message in messages" class="list-group-item">
					<span @click="removeMessage(message)" class="close glyphicon glyphicon-remove"></span>
					<span>{{ message.message }}</span>
				</div>
			</div>
		
			<form @submit.prevent="sendMessage()" class="form-inline">
				<div class="row">
					<div class="form-group col-sm-12">
						<div class="input-group col-sm-12">
		
							<input  type="text" v-model="newMessage" class="form-control" placeholder="What now?">
							<div @click.prevent="sendMessage()" class="input-group-addon bg-primary">Send</div>
		
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>

	
	<script src="/socket.io/socket.io.js"></script>
	<script src="/js/vue.js"></script>
	<script src="/js/vue-resource.js"></script>
	<script>
		var vue = new Vue({
			el: 'body',

			data: {
				socket: null,
				newMessage: '',
				messages: [],
			},

			ready: function() {
				this.$http.get('/server')
					.then(function(response) {
						var server = JSON.parse(response.data);
						this.socket = io.connect(server.domain + ':' + server.port);
						}.bind(this))
					.then(function() {
						this.registerSocketEvents();
						}.bind(this));
			},

			methods: {
				sendMessage: function() {
					if (this.newMessage.trim().length == 0) {
						return;
					}

					this.socket.emit('new-message', {message: this.newMessage});
				},

				removeMessage: function(message) {
					this.socket.emit('remove-message', message);
				},

				registerSocketEvents: function() {
					this.socket.on('connected', function(data) {
						this.messages = data.messages;
					}.bind(this));

					this.socket.on('message-saved', function (message) {
						this.messages.push(message);
						this.newMessage = '';
					}.bind(this));

					this.socket.on('message-removed', function(removedMessage) {
						var message = this.messages.find(function(message) {
							return message._id == removedMessage._id;
						});
						this.messages.$remove(message);
					}.bind(this));
				}
			}
		});
	</script>
	
</body>
</html>